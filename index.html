<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="./lib/d3v4.js"></script>
  <script src="./lib/cola.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Catamaran" rel="stylesheet">
</head>
<style>

.node text {
  stroke:#333;
  cursos:pointer;
}

.node circle{
  stroke:#fff;
  stroke-width:0px;
}

svg {
  border-style:solid;
  border-width:1px;
  border-color:#ddd;
  margin:0px;
  padding:0px;
}

body {
  margin:0px;
  padding:0px;
  font-family: 'Catamaran', sans-serif;
}

#sidebar {
  position:fixed;
  right:0px;
  top:0px;
  width: 298px;
  height:300px;
  background-color: #eee;
  padding:0px;
}

h2 {
  color: #395180;
  margin:10px;
}

h3 {
  color: #AB0520;
  margin:10px;
  text-align: center;
}

h4 {
  color: #395180;
  margin:15px;
}

p {
  color: #333;
  margin-left:15px;
  margin-right:15px;
  margin-bottom:3px;
  margin-top:3px;
  font-size:0.85em;
}

.button {
  background-color: #AB0520;
  border: none;
  color: white;
  padding: 10px 15px;
  margin-left:10px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 14px;
  cursor:pointer;
}

</style>
<body>

<div id="sidebar">

<img src="./img/uacs-logo.png" alt="UA CS logo" width="200" style="display:block;margin:auto;margin-top:15px;">
<h3>Undergrad Course Graph</h3>

<hr>
<div id="buttons" style="display:block;margin:auto;text-align:center;">
  <div style="margin-bottom:6px;">Color-code by</div>
  <span class="button" id="cmdepth">max depth</span>
  <span class="button" id="cyear">year</span>
  <span class="button" id="cnone">none</span>
</div>
<hr>

<h4 id="course-title"></h4>
<p id="course-desc"></p>

</div>

<script>

var cnone = document.getElementById('cnone');
cnone.onclick = function() {
  svg.selectAll(".node")
    .style("fill", function(d) { return "#bbb"; });
};

var cmdepth = document.getElementById('cmdepth');
  cmdepth.onclick = function() {
    svg.selectAll(".node")
      .style("fill", function(d) {
        return "rgb(" + (255-(d.mdepth*36)) +
            "," + (75 + (d.mdepth*20) * (1+d.mdepth%2)) + 
            "," + (d.mdepth*36) + ")";
  });
};

var cyear = document.getElementById('cyear');
cyear.onclick = function() {
  svg.selectAll(".node")
    .style("fill", function(d) {
      if (d.year == "fr") {
        return "#79c753";
      } else if (d.year == "so") {
        return "#45cec2";
      } else if (d.year == "jr") {
        return "#f0c419";
      } else if (d.year == "sr") {
        return "#f2552c";
      }
      return "#aaa";
    });
};

var width = window.innerWidth;
var height = window.innerHeight;
var sidebar_width = 300;

var svg = d3.select("body").append("svg")
  .attr("width", width - sidebar_width)
  .attr("height", height);
d3.select("#sidebar")
  .style("height", height + "px");

// Add grey arrow
svg.append("svg:defs")
  .append("svg:marker")
    .attr("class", "arrow")
    .attr("id", "arrow-grey")    
    .attr("refX",22)
    .attr("refY", 6)
    .attr("markerWidth", 53)
    .attr("markerHeight", 53)
    .attr("orient", "auto")
  .append("svg:path")
    .attr("d", "M2,2 L2,11 L10,6 L2,2")
    .attr("fill", "#ccc");
// Add red arrow
svg.select("defs")
  .append("svg:marker")
    .attr("class", "arrow")
    .attr("id", "arrow-red")    
    .attr("refX", 22)
    .attr("refY", 6)
    .attr("markerWidth", 53)
    .attr("markerHeight", 53)
    .attr("orient", "auto")
  .append("svg:path")
    .attr("d", "M2,2 L2,11 L10,6 L2,2")
    .attr("fill", "#AB0520");

var offset = width / 3;

var d3cola = cola.d3adaptor(d3)
    .size([width, height]);

window.addEventListener("resize", function(event) {
  width = window.innerWidth;
  height = window.innerHeight;
  d3.select("svg")
    .attr("width", width - sidebar_width)
    .attr("height", height);
  d3.select("#sidebar")
    .style("height", height + "px")
    .style("color", "#222");
  var offset = width / 3;
  force.size([width-offset, height]);
  force.start();
});

d3.json("graph.json", function(error, graph) {

  var nodeRadius = 5;
  graph.nodes.forEach(function (v) { v.height = v.width = 2 * nodeRadius; });

  d3cola
    .nodes(graph.nodes)
    .links(graph.links)
    .avoidOverlaps(true)
    .linkDistance(160)
    .symmetricDiffLinkLengths(50)
    .jaccardLinkLengths(120)
    .flowLayout('x', 150)
    .convergenceThreshold(1e-3)
    .start(30);

  var link = svg.selectAll(".link")
    .data(graph.links)
      .enter().append("line")
        .attr("class", "link")
        .attr("stroke", "#ccc")
        .style("stroke-width", 2);

  var all = [];
  
  function reset_all_edges() {
    var link = svg.selectAll(".link")
      .attr("stroke", "#ccc")
      .attr("marker-end", "url(#arrow-grey)");
  }
 
  function get_all_edges(e,t,indent) {
    if (e.__data__.target.name == t) {
      all.push(e);
      return true;
    } else {
      var truthy = false;
      var i = 0;
      for (i = 0; i < link._groups[0].length; i++) {
        if (link._groups[0][i].__data__.source.name == e.__data__.target.name) {
          var tres = get_all_edges(link._groups[0][i],t,indent+2);
          if (tres) { all.push(link._groups[0][i]); }
          truthy = truthy || tres;
        }
      }
      if (truthy) { all.push(e); }
      return truthy;
    }
  }

  function highlight_for_node(d,t) {
    reset_all_edges();
    all = [];
    get_all_edges(link._groups[0][0],t,2);
    for (i = 0; i < all.length; i++) {
      if (all[i] != undefined) {
        all[i].setAttribute("stroke", "#AB0520");
        all[i].setAttribute("marker-end", "url(#arrow-red)");
      }
    }
  }
      
  function node_click(d) {
    d3.select("#course-title")
      .text(d.name + ': ' + d.title);
    d3.select("#course-desc")
      .text(d.desc);
    highlight_for_node(d, d.name);
  }

  margin = 10;
  pad = 10;

  var node = svg.selectAll(".node")
    .data(graph.nodes)
    .enter().append("g")
      .attr("class", function(d) { return "node dd" + d.ddepth; })
      .attr("r","24")
      .on("click", function(d) { node_click(d); })
      .on("mousedown", function(d) { node_click(d); })
      .style("fill", function(d) { return d.color == undefined ? "#bbb" : d.color; })
      .call(d3cola.drag)
      .each(function (d) {
        var b = this.getBBox();
        var extra = 2 * margin + 2 * pad;
        d.width = b.width + extra;
        d.height = b.height + extra;
      });

  var arrow = svg.selectAll(".link")
    .attr('marker-end', 'url(#arrow-grey)');

  node.append("circle")
    .style("cursor", "pointer")
    .attr("r","24");

  node.append("text")
    .attr("dx", -10)
    .attr("dy", ".35em")
    .attr("fill","#000")
    .style("cursor", "pointer")
    .on("click", function(d) { node_click(d); })
    .text(function(d) { return d.name });

  d3cola.on("tick", function () {

    /* Help keep nodes in same column from overlapping */
    node.each(function(d) {
      svg.selectAll(".dd" + d.ddepth)
        .each(function(e) {
          if ( (d.title != e.title) && Math.abs(d.y - e.y) < 50) {
              if (e.y > d.y) { e.y += 1; d.y -= 1; }
              else { e.y -= 1; d.y += 1; }
          }
        });
    });

    link
      .attr("x1", function (d) { return (d.source.ddepth * 100); })
      .attr("y1", function (d) { return d.source.y; })
      .attr("x2", function (d) { return (d.target.ddepth * 100); })
      .attr("y2", function (d) { return d.target.y; });
    node
      .attr("cx", function (d) { return d.x; })
      .attr("cy", function (d) { return d.y; });
    node
      .attr("transform", function(d) {
          return "translate(" + (d.ddepth * 100) + "," + d.y + ")"; 
      });
  });

});

</script>
</html>
